{% extends "base.html" %}

{% block content %}
<div class="row dashboard-header">
  <div class="col">
    <h1>Patient Dashboard</h1>
    <p class="text-muted">Welcome, {{ patient.name }}</p>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header">My Profile</div>
      <div class="card-body">
        <p><strong>Username:</strong> {{ patient.username }}</p>
        <p><strong>Phone:</strong> {{ patient.phone }}</p>
        <p><strong>DOB:</strong> {{ patient.dob }}</p>
        <p><strong>Gender:</strong> {{ patient.gender }}</p>
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <!-- Notifications -->
    {% if notifications %}
    <div class="card mb-3 border-info">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">ðŸ”” Notifications</h5>
      </div>
      <ul class="list-group list-group-flush">
        {% for n in notifications %}
          {% if not n.is_read %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {{ n.message }}
              <br><small class="text-muted">{{ n.created_at }}</small>
            </div>
            <form action="{{ url_for('patient_mark_notification_read', notif_id=n.id) }}" method="POST">
              <button class="btn btn-sm btn-outline-secondary">Mark Read</button>
            </form>
          </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <ul class="nav nav-tabs mb-3" id="patientTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#results" type="button">Results & Reports</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history" type="button">Clinical History</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Results Tab -->
      <div class="tab-pane fade show active" id="results">
        <div class="list-group">
          {% for r in my_reports %}
          <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">{{ r.report_type }}</h5>
              <small>{{ r.created_at[:16] }}</small>
            </div>
            <p class="mb-1">{{ r.report_text }}</p>
            {% if r.image_filename %}
            <div class="mt-2">
              <a href="{{ url_for('uploads', filename=r.image_filename) }}" class="btn btn-sm btn-outline-primary" target="_blank">View Image/Scan</a>
            </div>
            {% endif %}
            <small class="text-muted">By: {{ r.staff_name }} ({{ r.staff_role }})</small>
          </div>
          {% else %}
          <p class="text-center text-muted py-3">No reports available.</p>
          {% endfor %}
        </div>
      </div>

      <!-- History Tab -->
      <div class="tab-pane fade" id="history">
        <h5 class="mt-3">Doctor Orders</h5>
        <div class="table-responsive mb-4">
          <table class="table table-sm">
            <thead><tr><th>Date</th><th>Doctor</th><th>Type</th><th>Notes</th></tr></thead>
            <tbody>
              {% for o in my_orders %}
              <tr>
                <td>{{ o.created_at[:10] }}</td>
                <td>Dr. {{ o.doctor_name }}</td>
                <td>{{ o.order_type }}</td>
                <td>{{ o.notes }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h5>Procedures / Scans</h5>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Date</th><th>Procedure</th><th>Status</th></tr></thead>
            <tbody>
              {% for a in my_assignments %}
              <tr>
                <td>{{ a.created_at[:10] }}</td>
                <td>{{ a.task_type }}</td>
                <td>{{ a.status }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
